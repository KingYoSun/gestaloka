# 既知の問題と注意事項

最終更新: 2025年6月30日

## 現在の問題

### 戦闘システムのレスポンス構造問題（2025/06/30）
- **問題**: ActionExecuteResponseにbattle_stateフィールドがない
- **詳細**: 
  - レスポンスのmetadataフィールドに戦闘情報が含まれている
  - GameSessionService.execute_actionのパラメータ名が不一致
  - パラメータ名: action_descriptionが期待されているがaction_textを渡している
- **影響**: PostgreSQLベースの戦闘統合テストが失敗
- **対応策**: 
  - レスポンス構造の正確な理解が必要
  - サービス層のインターフェース確認
  - テストコードの修正

### 型チェックエラー（バックエンド）
- **件数**: 39件
- **状況**: 既存コードの型定義不足によるもの
- **影響**: 動作には影響なし、型安全性の問題
- **主な箇所**:
  - SQLAlchemyクエリの型定義
  - Alembicマイグレーションファイル
  - AIエージェント関連のコード

### ESLint警告（フロントエンド）
- **件数**: 22件
- **内容**: `any`型の使用
- **影響**: 型安全性の低下
- **主な箇所**:
  - API通信のエラーハンドリング
  - 動的なフォームデータ
  - WebSocketイベント処理

### PostgreSQLテスト環境への移行（2025/06/30）
- **状況**: SQLiteベースからPostgreSQLベースへの移行進行中
- **完了項目**:
  - conftest.pyのPostgreSQL対応
  - テスト用データベースの自動作成・削除
  - トランザクションベースのテスト分離
- **移行中の項目**:
  - 既存テストの段階的な移行
  - フィクスチャの更新

## 技術的な注意事項

### データベース操作
1. **マイグレーション**:
   - 必ずAlembicを使用
   - 手動でのテーブル作成は禁止
   - 新しいモデルは`alembic/env.py`にインポート必須

2. **セッション管理**:
   - アプリケーションは同期的な`Session`を使用
   - `AsyncSession`は使用しない
   - Celeryタスクでは`get_session()`を使用

### モジュール構成
1. **存在しないモジュール**:
   - `app.db.database`は存在しない
   - `app.core.database`が正しいパス

2. **重複モジュール対策**:
   - テストファイルは`tests/`ディレクトリ内に配置
   - ルートディレクトリにテストファイルを置かない
   - 必要に応じて`__init__.py`を追加

### API設計
1. **SP購入エンドポイント**:
   - `/api/v1/sp/`配下に統合
   - `/api/v1/endpoints/sp_purchase.py`は古い実装

2. **WebSocketイベント**:
   - サービス層ではなくAPIエンドポイント層で実装
   - 非同期コンテキストが必要なため

## パフォーマンス考慮事項

### ログNPCエンカウント
- 大量のログ検索による遅延の可能性
- インデックスの追加を検討
- キャッシュ戦略の実装予定

### WebSocket通信
- 同時接続数の監視が必要
- イベントの送信頻度に注意
- 不要なブロードキャストを避ける

## セキュリティ考慮事項

### SP購入システム
- テストモードと本番モードの明確な分離
- 購入履歴の改ざん防止
- 権限チェックの徹底

### 認証・認可
- JWTトークンの有効期限管理
- ユーザー権限の適切な検証
- セッション管理の強化

## 開発時の注意点

### 型定義
- 新規コードは必ず型定義を追加
- `any`型の使用は最小限に
- 型エラーは放置しない

### テスト
- 新機能には必ずテストを追加
- 非同期と同期の混在に注意
- フィクスチャの適切な使用

### コード品質
- ruffとmypyのエラーは即座に修正
- ESLintの警告も可能な限り解消
- ドキュメントの同時更新