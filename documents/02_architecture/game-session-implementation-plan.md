# ゲームセッション実装計画

## 最終更新: 2025-07-21

## 概要

本ドキュメントは、ゲスタロカのゲームセッション機能の再実装計画を定義します。現在の状況分析に基づき、段階的かつ実践的なアプローチを採用します。

## 現在の状況

### 実装済み要素（データベース層）
- **モデル層**: GameSession、GameMessage、SessionResult、StoryArcが完全実装済み
- **スキーマ層**: 詳細なリクエスト/レスポンススキーマが定義済み
- **リレーション**: セッション間の継続性、ストーリーアーク管理が設計済み

### 未実装要素
- **APIエンドポイント**: game.pyが存在しない
- **WebSocketロジック**: 基本的な接続管理のみ
- **フロントエンドAPI統合**: 一時的な型定義で待機状態

## 実装前提条件

### 必須要件（開始前に完了すべき）
1. **型エラーの解消**（2-3日）
   - 自動生成ファイルのauthToken警告
   - WebSocket関連の型定義
   - SP関連の型不整合

2. **フロントエンドテストの修正**（1-2日）
   - DashboardPageテスト
   - LogsPageテスト

### 推奨開始時期
型エラーとテスト失敗を解消した直後（約3-5日後）

## 段階的実装計画

### フェーズ1: 基本APIエンドポイント（1週間）

#### 目標
RESTful APIでゲームセッションの基本的なCRUD操作を実現

#### 実装項目
1. **game.pyエンドポイント作成**
   ```python
   # /backend/app/api/api_v1/endpoints/game.py
   - POST /sessions - セッション作成
   - GET /sessions/{session_id} - セッション詳細取得
   - GET /sessions/history - セッション履歴
   - POST /sessions/{session_id}/continue - セッション継続
   - POST /sessions/{session_id}/end - セッション終了
   ```

2. **既存モデル・スキーマの活用**
   - GameSessionモデルをそのまま使用
   - game_session.pyスキーマを活用
   - 既存のサービス層（GameSessionService）を統合

3. **テスト作成**
   - 各エンドポイントのユニットテスト
   - 統合テスト（データベース連携）

#### 成果物
- 動作するREST API
- Swagger UIでの動作確認
- テストカバレッジ80%以上

### フェーズ2: WebSocketリアルタイム通信（1週間）

#### 目標
リアルタイムなゲームプレイ体験を実現

#### 実装項目
1. **WebSocketハンドラー実装**
   ```python
   # /backend/app/api/websockets/game_handler.py
   - join_game - セッション参加
   - leave_game - セッション離脱
   - send_action - アクション送信
   - receive_narrative - 物語受信
   ```

2. **イベント処理**
   - メッセージキューイング
   - 非同期処理の実装
   - エラーハンドリング

3. **状態管理**
   - セッション状態の同期
   - 接続管理とタイムアウト処理

#### 成果物
- WebSocket接続の確立
- リアルタイムメッセージ交換
- 複数クライアント対応

### フェーズ3: AIエージェント統合（1週間）

#### 目標
AI駆動の物語生成を統合

#### 実装項目
1. **Coordinator AI統合**
   - GameSessionServiceからCoordinatorAI呼び出し
   - プロンプトコンテキストの構築
   - レスポンス処理とメッセージ保存

2. **AI処理の最適化**
   - キャッシュ戦略の実装
   - 非同期処理による応答性向上
   - エラー時のフォールバック

3. **物語品質管理**
   - AIレスポンスの検証
   - 文脈の一貫性チェック
   - 感情価値の適切な設定

#### 成果物
- AI駆動の物語生成
- 滑らかなゲーム体験
- 適切なエラーハンドリング

### フェーズ4: フロントエンドUI実装（1週間）

#### 目標
洗練されたユーザーインターフェースの実装

#### 実装項目
1. **ゲームセッション画面**
   ```typescript
   // /frontend/src/features/game/
   - GameSessionPage.tsx
   - useGameSession.ts
   - GameInterface.tsx（ノベル/チャット切り替え）
   ```

2. **WebSocket統合**
   - 自動再接続
   - 状態同期
   - オプティミスティックUI

3. **UX最適化**
   - ローディング状態
   - エラー表示
   - アニメーション

#### 成果物
- 完全に動作するゲームUI
- ノベルモード/チャットモード
- 優れたユーザー体験

## リスクと対策

### 技術的リスク
1. **WebSocket接続の不安定性**
   - 対策: 自動再接続、状態復元機能

2. **AI応答の遅延**
   - 対策: ストリーミング応答、プログレス表示

3. **型定義の不整合**
   - 対策: OpenAPI Generatorによる自動生成

### スケジュールリスク
1. **予期せぬバグ**
   - 対策: 各フェーズでの徹底的なテスト

2. **仕様変更**
   - 対策: MVP優先、段階的な機能追加

## 成功指標

### 定量的指標
- テストカバレッジ: 80%以上
- API応答時間: 200ms以下
- WebSocket遅延: 50ms以下
- AI応答時間: 3秒以下

### 定性的指標
- スムーズなゲーム体験
- 直感的なUI/UX
- 安定した動作
- 拡張可能なアーキテクチャ

## 次のステップ

1. 型エラーとテスト失敗の解消（3-5日）
2. フェーズ1の開始準備
   - 開発環境の整備
   - 詳細設計の確認
   - チケット作成

## 関連ドキュメント

- [新ゲームセッション設計書](../05_implementation/new_game_session_design.md)
- [ゲームセッション処理フロー分析](../05_implementation/game_session_flow_analysis.md)
- [現在のタスク状況](../01_project/activeContext/current_tasks.md)