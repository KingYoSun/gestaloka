# 物語内探索システム

## 更新履歴
- 2025-07-06: 探索機能をセッション進行に統合（物語主導型設計への完全移行）

## 概要
探索は独立したシステムではなく、セッション進行（物語）の中で自然に発生する要素として実装されています。プレイヤーは物語の流れの中で探索を行い、ログフラグメントの発見や新たな場所への移動も物語として描写されます。

## システム構成

### 場所（Location）
ゲスタロカの世界は多数の「場所」で構成されています。

#### 場所の属性
- **名称**: 場所の固有名
- **タイプ**: 都市、町、ダンジョン、荒野、特殊
- **階層レベル**: 1-7の階層における位置
- **危険度**: 安全、低、中、高、極度
- **施設**: 宿屋、商店、ギルドの有無
- **座標**: マップ上の位置（X, Y）

#### 場所タイプの特徴
- **都市（City）**: 大規模な居住地、商業が盛ん、安全度高
- **町（Town）**: 中規模の居住地、基本的な施設あり
- **ダンジョン（Dungeon）**: 危険な探索地、レアフラグメント多数
- **荒野（Wild）**: 自然環境、中程度の危険度
- **特殊（Special）**: 特別なイベントや現象が発生する場所

### 場所間の移動

#### 移動メカニクス
1. **接続ルート**: 場所間には定められた接続ルートが存在
2. **SP消費**: 移動にはSPを消費（基本コスト＋階層深度＋危険度）
3. **レベル制限**: 一部のルートには最小レベル要件
4. **一方通行**: 特定のルートは一方向のみ通行可能

#### SP消費計算式
```
移動SP = 基本コスト + (階層レベル - 1) × 2 + 危険度ボーナス

危険度ボーナス:
- 安全: 0
- 低: 1
- 中: 3
- 高: 5
- 極度: 10
```

### エリア探索

各場所には複数の「探索エリア」が存在し、プレイヤーはSPを消費して探索できます。

#### 探索エリアの属性
- **難易度**: 1-10のスケール
- **探索SP消費**: エリアごとに設定
- **最大発見数**: 一度の探索で発見可能なフラグメント数
- **レア発見率**: レアフラグメント出現確率
- **遭遇率**: 歪みや敵対的存在との遭遇確率

#### 探索結果
- **ログフラグメント発見**: 場所とエリアに応じたフラグメント
- **アイテム発見**: （将来実装予定）
- **特殊イベント**: エリア固有のイベント発生
- **歪み遭遇**: 戦闘や交渉の可能性

### ログフラグメント発見

探索の主要な目的は、ログフラグメントの発見です。

#### フラグメント生成ロジック
1. **場所タイプによるキーワード決定**
   - 都市: urban_memory, crowded_streets, merchant_tale
   - ダンジョン: ancient_secret, trapped_soul, lost_treasure
   - など

2. **危険度による感情価決定**
   - 安全・低危険度: ポジティブ・中立的
   - 高・極度危険度: ネガティブ・混合

3. **レアリティ判定**
   - 基本的にはコモン・アンコモン
   - レア発見率に基づいてレア以上が出現

## 実装状況（2025-07-06完了）

- ✅ 場所データモデル定義
- ✅ セッション内での探索処理統合
- ✅ SP消費メカニズム
- ✅ フラグメント生成ロジック
- ✅ 初期場所データのシード
- ✅ 物語としての探索結果生成

## 探索アクションの処理

探索はセッションアクションAPI（`POST /api/v1/game/sessions/{session_id}/action`）を通じて処理されます。プレイヤーが「周囲を探索する」「北へ向かう」などの意図を表現すると、AIが物語の文脈の中で適切な探索結果を生成します。

## 初期場所データ

### The Nexus（開始地点）
- タイプ: 特殊
- 階層: 1
- 危険度: 安全
- 全施設あり

### Market District
- タイプ: 都市
- 階層: 1
- 危険度: 低
- 商店・宿屋あり

### Outer Ward
- タイプ: 町
- 階層: 1
- 危険度: 低
- 宿屋のみ

### Forgotten Archives
- タイプ: ダンジョン
- 階層: 2
- 危険度: 中
- 施設なし

### Astral Conduit
- タイプ: 特殊
- 階層: 3
- 危険度: 高
- 施設なし

## 今後の拡張予定

### 物語内での探索の深化
- 場所の歴史や秘密を物語として徐々に明かす
- プレイヤーの選択が場所の状態に影響
- NPCとの出会いを通じた場所の理解深化
- ログ編纂による新たな場所の開放

## ゲームデザイン上の意図

**更新（2025-07-06）**: 物語主導型設計への完全移行

1. **物語に溶け込む探索**: 探索が物語の自然な一部として展開
2. **文脈に基づく発見**: AIが物語の流れに応じて適切な発見を演出
3. **シームレスな体験**: 探索と物語進行の境界をなくす
4. **没入感の向上**: プレイヤーは「探索している」ことを意識せず、物語を体験

## バランス設計

- **新規プレイヤー**: 安全な場所で基本を学べる
- **中級プレイヤー**: 適度な危険度でチャレンジ
- **上級プレイヤー**: 高リスク高リターンの探索
- **SP経済**: 移動・探索・他システムとのバランス