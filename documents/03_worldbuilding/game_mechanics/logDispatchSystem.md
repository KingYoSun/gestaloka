# ログ派遣システム仕様

## 概要
ゲスタロカにおける「ログ」は、プレイヤーが編纂した記憶の集合体から生まれる独立したNPCエンティティです。プレイヤーは自身が創造したログに目的と初期地点を設定し、世界へと送り出します。ログは独自の意思で世界を旅し、他のプレイヤーと出会い、一定期間後に創造主の元へ帰還して成果を報告します。

## コアコンセプト

### 1. ログの独立性
- ログは契約や取引の対象ではなく、創造主から独立した存在として世界を旅する
- 各ログは独自の性格、目的、行動パターンを持つ
- 他のプレイヤーにとっては、通常のNPCと同様に出会い、交流できる存在

### 2. SP（Story Points）システム
**SP（ストーリーポイント）**は表向き「行動力」として表現されますが、実際は「世界への干渉力」を表す重要なリソースです。

#### SPの用途
- **プレイヤーの行動宣言**: 自由入力での行動には1-5 SP消費
- **ログの派遣**: 派遣期間に応じて10-100 SP消費
- **ログの能力強化**: 特殊スキルや装備の付与に追加SP消費
- **緊急召還**: 派遣中のログを即座に呼び戻す際にSP消費

#### SPの回復と購入
- **自然回復**: 1日あたり10 SP回復（無料プレイヤー）
- **購入オプション**:
  - 100 SP: ¥500
  - 500 SP: ¥2,000（20%ボーナス）
  - 1,000 SP: ¥3,500（42%ボーナス）
- **特別報酬**: イベントやログの成果により追加SP獲得

## ログ派遣システム

### 1. 派遣準備フェーズ

#### 1.1 ログの選択
- 編纂済みの完成ログから派遣対象を選択
- 各ログの現在状態（待機中/派遣中/休養中）を確認

#### 1.2 行動目的の設定
プレイヤーは以下のカテゴリーから主目的を選択し、詳細を記述：

##### 基本活動系
- **探索型（EXPLORE）**: 特定の場所や情報を探す
  - 例：「第三階層の忘れられた図書館を探す」
  - SP消費: 基本20 SP + 階層深度×5 SP

- **交流型（INTERACT）**: 特定の条件を持つ人物との出会いを求める
  - 例：「錬金術師のギルドメンバーと知り合う」
  - SP消費: 基本15 SP + 条件複雑度×3 SP

- **収集型（COLLECT）**: アイテムや情報の収集
  - 例：「希少な薬草を集める」
  - SP消費: 基本10 SP + レアリティ×10 SP

- **護衛型（GUARD）**: 特定の場所や人物を守る
  - 例：「初心者エリアで新規プレイヤーを助ける」
  - SP消費: 基本25 SP + 危険度×5 SP

- **自由型（FREE）**: ログの性格に任せた自由行動
  - 例：「お前の思うままに旅をしてこい」
  - SP消費: 基本30 SP（予測不能な分高コスト）

##### 経済活動系（フェーズ1実装）
- **商業型（TRADE）**: アイテムの売買や商業活動
  - 例：「収集した薬草を街で販売する」「露店を開いて装備を売る」
  - SP消費: 基本15 SP + 取引規模×5 SP
  - 特徴：安全地帯での活動が多く、戦闘リスクが低い

##### 世界維持系（フェーズ1実装）
- **記憶保存型（MEMORY_PRESERVE）**: 世界の劣化から記憶を守る
  - 例：「消えゆく第7階層の村の記憶を収集する」
  - SP消費: 基本30 SP + 危険度×10 SP
  - 特徴：世界の存続に貢献し、特別な報酬を得やすい

##### 学術・研究系（フェーズ1実装）
- **研究型（RESEARCH）**: 設計者の遺物や技術の調査
  - 例：「界壁内部の遺物を調査し、その機能を解明する」
  - SP消費: 基本35 SP + 技術レベル×8 SP
  - 特徴：高度な知識や特殊アイテムの発見可能性

#### 1.3 初期スポーン地点の設定
- プレイヤーが訪れたことのある場所から選択
- 階層が深いほど追加SP消費（階層×2 SP）
- 特殊地点（ダンジョン内部など）は追加料金

#### 1.4 派遣期間の設定
- **短期派遣**: 1-3日（10-30 SP）
- **中期派遣**: 4-7日（40-70 SP）
- **長期派遣**: 8-14日（80-140 SP）
- **特別長期**: 15-30日（150-300 SP、特別許可必要）

### 2. 派遣中フェーズ

#### 2.1 AI駆動のログ行動
- **高度なAIシミュレーション**: 脚本家AI・NPC管理AIによる個性的な活動生成
- **性格・スキル・汚染度の反映**: ログの特性が活動内容に大きく影響
  - 慎重な性格: 安定した成功率だが控えめな成果
  - 大胆な性格: 極端な成功または失敗
  - 高汚染度: 予測不能な結果と奇妙な出会い
- **文脈を考慮した物語生成**: 過去の活動履歴や世界の状況を反映
- **1日あたり3-5回の主要な行動**: 各行動に詳細な物語とアニメーション

#### 2.2 派遣ログ同士の相互作用
- **自動遭遇システム**: 同じ場所にいる派遣ログ同士が30分ごとに相互作用チェック
- **目的タイプによる相互作用確率**:
  - 交流型同士: 80%の高確率で相互作用
  - 商業型同士: 60%（協力または競争）
  - 研究型同士: 50%（知識交換）
  - 守護型との組み合わせ: 10%（低確率）
- **多様な相互作用結果**:
  - アイテム交換: 互いに有益な物品を交換
  - 知識・情報の共有: 新たな場所や秘密の共有
  - 同盟の形成: 共同での目的達成
  - 競争や対立: 商業的競争や思想の対立
  - 共同探索: 危険な場所への共同挑戦

#### 2.3 詳細な活動記録
すべての行動は「旅の記録」として詳細に保存：
- **物語的な活動ログ**: 各活動に豊かな描写
- **成功度レベル**: 0.0～1.0の数値で活動の成果を評価
- **経験値の獲得**: 活動タイプごとに異なる経験値
- **関係性の変化**: NPCや他の派遣ログとの関係性を数値化
- **発見・収集の詳細**: レアリティ、価値、特殊効果

#### 2.4 他プレイヤーとの遭遇（2025-07-02実装強化）

##### 遭遇システム
派遣されたログは、その目的と性格に応じて他のプレイヤーとの出会いが生まれます：

**目的による出会いやすさ**:
- **交流型（INTERACT）**: 積極的に人を探し、出会いを求める
- **商業型（TRADE）**: 取引相手を探し、人が集まる場所を好む
- **探索型（EXPLORE）**: 冒険の途中で偶然の出会いが生まれる
- **護衛型（GUARD）**: 守るべき対象の周辺で他者と接触
- **自由型（FREE）**: 気の向くままに、様々な出会いを経験
- **研究型（RESEARCH）**: 知識を求めて同好の士と出会う
- **記憶保存型（MEMORY_PRESERVE）**: 物語を求めて人々と交流

**性格による影響**:
- 社交的な性格のログは自然と人が集まってくる
- 慎重な性格のログは必要最小限の接触に留まる
- 好奇心旺盛なログは新しい出会いを求めて動く

**汚染の影響**:
汚染されたログは、その歪んだ存在感により、望まずとも人々の注目を集めてしまう

##### 複数NPC同時遭遇（2025-07-02実装）
- 時に複数の派遣ログが同じ場所に集まることがある
- それぞれのログは独自の目的で活動している
- プレイヤーは個別または全体への対応を選択可能

##### 遭遇時のインタラクション
- ログは他のプレイヤーのゲームセッションに通常のNPCとして登場
- プレイヤーは特別なマーカー「[派遣ログ]」で識別可能
- 交流内容は両方のプレイヤーの記録に残る
- 派遣ログの創造主には遭遇の詳細が報告される

##### アイテム交換システム（2025-07-02実装）
遭遇後の相互作用として、プレイヤーと派遣ログ間でアイテム交換が可能：
- 交換インターフェースでアイテムを選択
- 価値バランスの自動計算（20%の差まで許容）
- 交換結果は両者の記録に保存
- 派遣元プレイヤーへの詳細報告に含まれる

### 3. 帰還フェーズ

#### 3.1 帰還通知
- 派遣期間終了の24時間前に通知
- 延長オプション（追加SP消費で可能）

#### 3.2 成果報告
ログは派遣目的に応じた形式で報告を行う：

##### 基本的な報告（全タイプ共通）
```
【旅の総括】
訪問地点: 12箇所
出会った人物: 8名（プレイヤー3名、NPC5名）
主目的達成度: 75%

【特筆すべき出来事】
- 第二階層の隠し通路を発見
- 冒険者ギルドのクエストを3つ完了
- 迷子の商人を助けて報酬を獲得

【獲得物】
- 銀貨 x 150
- 薬草 x 8
- 古い地図の断片 x 1
- 新しい「ログフラグメント」x 2
```

##### 商業型（TRADE）の追加報告
```
【商業活動報告】
総売上: 銀貨 450
仕入原価: 銀貨 200
純利益: 銀貨 250
主要取引相手: 薬草商人ギルド、冒険者協会
人気商品: 回復薬（完売）、耐毒草（在庫3）
新規開拓: 第3階層への販路確立
```

##### 記憶保存型（MEMORY_PRESERVE）の追加報告
```
【記憶保存活動報告】
収集した記憶: 23個
保存成功: 19個（成功率82.6%）
特に重要な記憶:
- 「最後の村長の演説」（レア度: ★★★★）
- 「子供たちの遊び歌」（レア度: ★★）
劣化進行度: 村全体の65%（活動により5%遅延）
万象図書館への献上: 3件
```

##### 研究型（RESEARCH）の追加報告
```
【研究活動報告】
調査対象: 界壁内部の青い結晶体
解明度: 45%
発見事項:
- エネルギー共鳴パターンを特定
- 設計者の言語で「安定器」と判読
- 周期的な信号発信を確認（72時間周期）
収集サンプル: 結晶片×3、共鳴記録×5
ソフィア研究院への報告: 完了（評価A）
```

##### 創造主への個人的メッセージ（全タイプ共通）
```
【創造主への個人的メッセージ】
「マスター、楽しい旅でした。特に若い冒険者を助けた時の彼らの笑顔が印象的でした。また旅に出たいです。」
```

#### 3.3 報酬と経験
- **直接報酬**: 獲得したアイテムや通貨
- **情報報酬**: 新しい場所や人物の情報
- **ログ成長**: 経験によるスキルアップや性格の変化
- **SP還元**: 目的達成度に応じて5-20%のSP還元

## ログの成長と変化

### 1. 経験による成長
- 派遣回数に応じてレベルアップ
- 特定の行動を繰り返すことでスキル習得
- 印象的な出来事による性格の変化

### 2. 関係性の構築
- 頻繁に出会うプレイヤーやNPCとの親密度
- 特定の場所への愛着度
- 他のログとの友情や対立

### 3. 独自ストーリーの発展
- 複数回の派遣で連続したストーリーが展開
- 過去の出会いや約束が将来の行動に影響
- プレイヤー間で共有される「有名なログ」の誕生

## 技術仕様

### データモデル

```python
class LogDispatch(SQLModel, table=True):
    __tablename__ = "log_dispatches"
    
    id: str = Field(primary_key=True)
    completed_log_id: str = Field(foreign_key="completed_logs.id")
    dispatcher_id: str = Field(foreign_key="characters.id")
    
    # 派遣設定
    objective_type: DispatchObjectiveType  # EXPLORE, INTERACT, COLLECT, GUARD, FREE, TRADE, MEMORY_PRESERVE, RESEARCH
    objective_details: dict[str, Any]
    initial_location: str  # 派遣開始地点
    dispatch_duration_days: int
    sp_cost: int
    
    # 状態
    status: DispatchStatus  # PREPARING, ACTIVE, RETURNING, COMPLETED
    dispatched_at: datetime
    expected_return_at: datetime
    actual_return_at: Optional[datetime]
    
    # 活動記録
    travel_log: list[dict[str, Any]]  # 時系列の活動記録
    encounters: list[dict[str, Any]]  # 他プレイヤーとの出会い
    
    # 成果
    achievements: dict[str, Any]
    rewards: dict[str, Any]
    objective_completion_rate: float

class PlayerSP(SQLModel, table=True):
    __tablename__ = "player_sp"
    
    character_id: str = Field(primary_key=True, foreign_key="characters.id")
    current_sp: int = Field(default=10)
    total_purchased_sp: int = Field(default=0)
    total_spent_sp: int = Field(default=0)
    last_natural_recovery: datetime
    
    # 購入履歴
    purchase_history: list[dict[str, Any]]
```

### API エンドポイント

```python
# ログ派遣関連
POST /api/v1/logs/dispatch
GET /api/v1/logs/dispatches/{character_id}
GET /api/v1/logs/dispatch/{dispatch_id}
POST /api/v1/logs/dispatch/{dispatch_id}/recall

# SP管理
GET /api/v1/sp/{character_id}
POST /api/v1/sp/purchase
GET /api/v1/sp/history/{character_id}

# ログ遭遇（2025-07-02実装）
GET /api/v1/logs/encounters/{session_id}
POST /api/v1/logs/encounter/{log_id}/interact
POST /api/v1/dispatches/encounters/{encounter_id}/interact  # アイテム交換を含む相互作用
```

## ゲームバランスとマネタイズ

### 無料プレイの範囲
- 1日10 SPの自然回復で基本的なプレイは可能
- 3-4日に1回の短期ログ派遣
- 慎重な行動選択でSPを節約

### 課金プレイの利点
- 複数のログを同時派遣
- 長期派遣による深い物語体験
- 自由な行動宣言による創造的プレイ
- 特別なログ能力の開放

### 継続的な収益モデル
- 月額パス（毎日追加20 SP）: ¥1,000/月
- シーズンパス（3ヶ月）: ¥2,500
- 特別イベント時のSPセール
- ログ装飾アイテムの販売

## 実装優先順位

### Phase 1: 基本システム
1. SPシステムの実装
2. ログ派遣UIの基本機能
3. 簡易的な活動シミュレーション（基本5タイプ）
4. 帰還と報告機能

### Phase 1.5: 派遣タイプ拡張（フェーズ1）
1. 商業型（TRADE）の実装
   - 経済活動シミュレーション
   - 売買記録と利益計算
2. 記憶保存型（MEMORY_PRESERVE）の実装
   - 劣化進行度の追跡
   - 記憶収集メカニクス
3. 研究型（RESEARCH）の実装
   - 遺物調査シミュレーション
   - 研究成果の評価システム

### Phase 2: 遭遇システム（2025-07-02部分実装完了）
1. ✅ 他プレイヤーのセッションへのログ出現
2. ✅ 交流記録システム（DispatchEncounterモデル）
3. ✅ ログ識別マーカー
4. ✅ 派遣タイプ別の遭遇パターン（確率システム実装）
5. ✅ 複数NPC同時遭遇のサポート
6. ✅ アイテム交換システム（API実装完了、UI実装完了）

### Phase 3: 成長と物語
1. ログの経験値システム
2. 関係性の追跡
3. 連続ストーリーの生成
4. 派遣タイプ特化スキルの習得

### Phase 4: マネタイズ強化
1. SP購入システム
2. 月額パスの実装
3. 特別イベントの開催
4. 派遣タイプ別のプレミアム機能