# ゲームセッション実装の全面的なやり直しについて

作成日: 2025-07-11

## 背景

初回セッションで導入ストーリーが表示されない問題の修正を試みたが、以下の問題が解決できなかった：

1. WebSocket接続が確立されない（"Waiting for WebSocket connection"が継続）
2. `websocketManager.isConnected()`が常にfalseを返す
3. `join_game`イベントが送信されない
4. 結果として初回セッションの導入ストーリーが表示されない

複数の修正を試みたが根本的な解決に至らず、現在の実装は複雑になりすぎており、これ以上の修正は困難と判断。

## 決定事項

**ゲームセッション関連の実装を全て破棄し、ゼロから再実装する**

### 理由

1. **現在の実装の複雑性**
   - WebSocketとREST APIの混在
   - 状態管理の重複（Zustand、ローカルstate、サーバー側）
   - イベントフローの不明瞭さ

2. **デバッグの困難さ**
   - WebSocket接続の問題が特定できない
   - イベントの発火タイミングが不明瞭
   - テストは通るが実際の動作で問題が発生

3. **技術的負債**
   - 度重なる修正により、コードの見通しが悪化
   - 不要なコードやワークアラウンドの蓄積
   - ドキュメントと実装の乖離

## 実施計画

### フェーズ1: 既存実装のアーカイブ

1. アーカイブディレクトリの作成
   - `/archived/game_session_v1/`
   - バックエンドとフロントエンドで分離

2. 移動対象ファイル
   - **バックエンド**
     - `/backend/app/services/game_session.py`
     - `/backend/app/api/api_v1/endpoints/game.py`
     - `/backend/app/websocket/server.py`
     - `/backend/app/ai/agents/coordinator.py`
     - `/backend/app/ai/agents/first_session_initializer.py`
     - 関連テストファイル
   
   - **フロントエンド**
     - `/frontend/src/hooks/useGameSessions.ts`
     - `/frontend/src/hooks/useWebSocket.ts`
     - `/frontend/src/stores/gameSessionStore.ts`
     - `/frontend/src/routes/_authenticated/game/`
     - `/frontend/src/components/game/`
     - 関連テストファイル

3. データベースマイグレーション
   - 既存のゲームセッション関連テーブルはそのまま維持
   - 新実装で必要に応じて修正

### フェーズ2: 新実装の設計

1. **シンプルな設計原則**
   - WebSocketのみでゲームセッションを管理
   - REST APIは認証とメタデータのみ
   - 状態管理を一元化

2. **最小限の機能から開始**
   - セッション開始
   - メッセージ送受信
   - セッション終了

3. **段階的な機能追加**
   - NPCエンカウンター
   - 戦闘システム
   - セッション終了提案
   - リザルト処理

### フェーズ3: 新実装

1. **基本構造の実装**
   - WebSocketサーバーの最小実装
   - クライアントの最小実装
   - 基本的なメッセージフロー

2. **テスト駆動開発**
   - 各機能を小さな単位でテスト
   - 統合テストの充実

3. **ドキュメント先行**
   - 実装前に仕様を明確化
   - APIドキュメントの作成

## 期待される成果

1. **シンプルで保守しやすいコード**
2. **明確なデータフロー**
3. **信頼性の高いWebSocket通信**
4. **拡張しやすいアーキテクチャ**

## タイムライン

- **今日（2025-07-11）**: アーカイブ作業の実施
- **次回作業時**: 新設計の詳細策定
- **その後**: 段階的な実装

## 注意事項

- 既存のデータは保持（プレイヤーのセッション履歴など）
- 新実装は既存データとの互換性を考慮
- ユーザーへの影響を最小限に抑える