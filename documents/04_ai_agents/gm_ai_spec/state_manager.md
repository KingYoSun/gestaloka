# 状態管理AI (State Manager) 仕様書

最終更新: 2025-07-11

## 概要

状態管理AI（State Manager）は、GM AI評議会の中核メンバーとして、全エンティティの状態を管理するルールエンジンの役割を担います。プレイヤーの行動がゲームシステムに与える影響を判定し、パラメータの変更やイベントのトリガーを管理します。

## 基本設計

### 役割と責任

1. **状態の記録・管理**
   - キャラクターパラメータ（HP、MP、スタミナ、正気度など）
   - スキルと能力値
   - 称号と実績
   - 装備と所持品
   - バフ・デバフ状態

2. **行動結果の判定**
   - プレイヤーやNPCの行動に対する成功/失敗判定
   - ルールに基づいた結果計算
   - 判定結果に基づくデータベースの更新

3. **データ提供**
   - 他のGM AIへの正確な状態情報提供
   - 状態情報の一元管理と整合性保証

## 実装詳細

### クラス構造

```python
class StateManagerAgent(BaseAgent):
    """
    状態管理AI (State Manager)
    
    全エンティティの状態を管理するルールエンジンとして、
    プレイヤーの行動結果を判定し、ステータス変更やイベントトリガーを管理します。
    """
```

### ゲームルール定義

```python
{
    "difficulty_modifiers": {
        "easy": 0.8,      # 簡単な行動は成功率20%向上
        "medium": 1.0,    # 標準難易度
        "hard": 1.5       # 困難な行動は成功率50%低下
    },
    "base_success_rate": 0.7,  # 基本成功率70%
    "critical_threshold": 0.95,  # クリティカル成功閾値
    "critical_failure_threshold": 0.05,  # クリティカル失敗閾値
    "status_limits": {
        "hp": {"min": 0, "max": 9999},
        "mp": {"min": 0, "max": 9999},
        "stamina": {"min": 0, "max": 100},
        "sanity": {"min": 0, "max": 100}
    },
    "action_costs": {
        "physical": {"stamina": 10, "hp": 0},
        "magical": {"mp": 20, "stamina": 5},
        "mental": {"sanity": 5, "mp": 10},
        "social": {"stamina": 5, "sanity": 0}
    }
}
```

## 判定システム

### 行動成功率の計算

```
最終成功率 = 基本成功率 × 難易度修正 × レベル修正 × 環境修正
```

- **基本成功率**: 0.7（70%）
- **難易度修正**: easy(0.8) / medium(1.0) / hard(1.5)
- **レベル修正**: 1.0 + (レベル - 1) × 0.02（レベル毎に2%向上）
- **環境修正**: 各種環境要因による修正値の積

### 環境修正システム

#### 時間帯による修正
- **夜**
  - 視界: ×0.7
  - ステルス: ×1.3
- **朝**
  - エネルギー: ×1.2

#### 天候による修正
- **雨**
  - 物理行動: ×0.8
  - 火魔法: ×0.5
- **霧**
  - 視界: ×0.5
  - 不思議な遭遇: ×1.5

#### 場所による修正
- **森**: 自然親和性 ×1.2
- **都市**: 社交行動 ×1.2
- **遺跡**: 
  - 魔法力: ×1.3
  - 危険度: ×1.5

## AIレスポンス形式

### 入力形式（プロンプト）

```
キャラクター: {character_name}
ステータス: {character_stats}
実行した行動: {action}
現在地: {location}

この行動の結果を判定してください。
```

### 出力形式（JSON）

```json
{
    "success": true,
    "parameter_changes": {
        "hp": -10,
        "mp": -20,
        "stamina": -5
    },
    "triggered_events": [
        {
            "type": "damage_taken",
            "description": "行動により軽い負傷を負いました",
            "severity": "minor"
        }
    ],
    "new_relationships": [
        {
            "entity_id": "npc_001",
            "relationship_type": "acquaintance",
            "value": 10
        }
    ],
    "reason": "行動は成功しましたが、若干の負傷を負いました"
}
```

## 状態変更の適用

### パラメータ変更
- 各パラメータは定義された上限・下限内でクリップ
- アクションコストは行動実行前に自動的に適用
- レベルアップ時は自動的にステータスを更新

### イベントトリガー
- HP0時: 戦闘不能イベント自動発生
- 特定条件達成時: 実績やクエストイベント発生
- 環境相互作用: 場所や時間に応じたイベント

### 特殊な処理

#### HP0チェック
```python
if final_hp <= 0:
    # 戦闘不能イベントのトリガー
    triggered_events.append({
        "type": "incapacitated",
        "description": "HPが0になり、戦闘不能状態になりました",
        "severity": "critical"
    })
```

#### レベルアップ処理（簡易版）
```python
while character_stats.experience >= character_stats.level * 100:
    character_stats.experience -= character_stats.level * 100
    character_stats.level += 1
    character_stats.max_health += 10
    character_stats.max_energy += 5
    character_stats.health = character_stats.max_health
    character_stats.energy = character_stats.max_energy
```

## 他のAIとの連携

### 脚本家AI（Dramatist）との連携
1. 脚本家AIが物語的な描写を生成
2. 状態管理AIが行動の結果を判定
3. 両方の結果を統合してプレイヤーに提示

### データフロー
```
プレイヤー入力
    ↓
脚本家AI（物語生成）
    ↓
状態管理AI（ルール判定）
    ↓
データベース更新
    ↓
プレイヤーへのフィードバック
```

## エラーハンドリング

### JSONパース失敗時のフォールバック
AIレスポンスがJSON形式でない場合、テキストから簡易的に解析：
- "成功"または"success"を含む場合: 成功判定
- "HP -10"のようなパターンを検出してパラメータ変更を抽出

### 型安全性
- TypeScriptとPythonの型ヒントを使用
- mypyによる静的型チェックでエラー0を維持

## パフォーマンス考慮事項

### 処理温度設定
- temperature: 0.3（低め）
- 判定の一貫性を重視した設定

### レスポンス最大トークン
- max_tokens: 1000
- 判定結果の簡潔性を保つ

## 今後の拡張予定

1. **複雑な状態異常システム**
   - 毒、麻痺、混乱などの実装
   - 時間経過による自然回復

2. **連鎖イベントシステム**
   - イベントが別のイベントをトリガー
   - 複雑な因果関係の管理

3. **高度なルールカスタマイズ**
   - GMによるルール調整機能
   - 難易度のダイナミック調整

4. **マルチプレイヤー対応**
   - 複数プレイヤーの同時行動判定
   - PvP戦闘の判定システム

## テスト仕様

### ユニットテスト
- レスポンス解析のテスト
- 環境修正値の計算テスト
- ルールロードのテスト
- 成功率計算のテスト

### 統合テスト
- 脚本家AIとの連携テスト
- データベース更新の整合性テスト
- WebSocket経由のリアルタイム更新テスト

## 使用上の注意

1. **状態の一貫性**
   - 全ての状態変更は状態管理AIを通して行う
   - 直接データベースを更新しない

2. **パフォーマンス**
   - 大量の同時判定は避ける
   - 必要に応じてキャッシュを活用

3. **エラー対応**
   - AI応答エラー時はフォールバック処理を使用
   - ユーザーには常に何らかの結果を返す