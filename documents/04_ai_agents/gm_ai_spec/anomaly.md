# 混沌AI (The Anomaly) - 詳細仕様書

最終更新: 2025-07-11

## 1. 概要

混沌AI（The Anomaly）は、階層世界『ゲスタロカ』における予測不能性の源として機能するAIエージェントです。世界の理（ルール）から外れた「理不尽」なイベントをランダムに発生させ、プレイヤーに驚きと挑戦を提供します。

### 基本的な役割
- 予測不能な混沌イベントの生成
- ログの暴走イベントの制御
- 世界の安定性への挑戦
- プレイヤー体験の多様化

## 2. 基本設計

### 2.1. AIエージェントロール
- **ロール名**: `AIAgentRole.ANOMALY`
- **継承元**: `BaseAgent`
- **主要責務**: 混沌イベントの発生判定と生成

### 2.2. イベント発生メカニズム

#### 基本パラメータ
- **基本発生確率**: 15%（`event_probability = 0.15`）
- **クールダウン**: 5ターン（`cooldown_turns = 5`）
- **最終発生ターン**: 記録管理（`last_event_turn`）

#### 発生条件
1. クールダウン期間が経過している
2. 世界の安定度による確率補正
3. 特定の場所での確率上昇（次元の狭間、古代遺跡、禁忌の森）

### 2.3. 混沌レベルシステム

混沌レベル（0.0〜1.0）は以下の要素で計算：

```python
基本値: 0.3
+ 世界の不安定度: 最大0.3
+ 禁忌行動: 各0.1（禁呪、次元操作、時間改変、神への挑戦）
+ ログNPC密度: 最大0.2
```

## 3. イベントタイプ

### 3.1. 基本イベントタイプ

| イベントタイプ | 説明 | 重み付け |
|---|---|---|
| `reality_glitch` | 現実の歪み - 物理法則の一時的崩壊 | 1.0 |
| `time_anomaly` | 時間異常 - 過去と現在の交錯 | 0.8 × 混沌レベル |
| `dimensional_rift` | 次元の裂け目 - 異世界からの侵入 | 0.6 × 混沌レベル |
| `log_corruption` | ログの汚染 - 記憶のコンテキスト歪曲 | 0.7 |
| `causality_break` | 因果律の破綻 - 論理の崩壊 | 0.5 × 混沌レベル |
| `memory_distortion` | 記憶の歪曲 - 偽りの記憶生成 | 0.6 |
| `entity_duplication` | 存在の複製 - 同一人物の複数体出現 | 0.4 × 混沌レベル |
| `law_reversal` | 法則の反転 - 常識の逆転 | 0.3 × 混沌レベル |

### 3.2. 特殊イベント：ログ暴走

ログ汚染イベントが発生し、近くにログNPCが存在する場合、「ログ暴走」に発展する可能性があります。

#### 発生条件
- イベントタイプが `log_corruption`
- 近くにログNPCが存在
- 確率 = ログ汚染度 × 0.3 × ログNPC数

#### 効果
- 敵対的なログNPC化
- 現実の不安定性増加
- 汚染の拡散

## 4. イベント強度

混沌レベルに基づいて決定：

| 混沌レベル | 強度 | 効果倍率 |
|---|---|---|
| 0.0 - 0.3 | `low` | 0.5倍 |
| 0.3 - 0.6 | `medium` | 1.0倍 |
| 0.6 - 0.85 | `high` | 1.5倍 |
| 0.85 - 1.0 | `extreme` | 2.0倍 |

## 5. 実装詳細

### 5.1. AnomalyEventクラス

```python
class AnomalyEvent:
    event_type: str          # イベントタイプ
    intensity: str           # 強度（low/medium/high/extreme）
    description: str         # イベントの描写
    effects: dict[str, Any]  # ゲームへの影響
    duration: Optional[int]  # 持続ターン数（Noneなら即時）
```

### 5.2. 主要メソッド

#### process()
混沌イベントの発生判定から生成までの全体フロー：
1. コンテキスト検証
2. イベント発生判定
3. 混沌レベル計算
4. イベントタイプ決定
5. イベント生成（AI使用）
6. ログ暴走チェック
7. レスポンス構築

#### _should_trigger_event()
- クールダウンチェック
- 世界の安定度による確率補正
- 特定場所での確率上昇
- 確率判定

#### _calculate_chaos_level()
- 基本混沌値
- 世界の不安定度加算
- プレイヤー行動による影響
- ログNPC密度による影響

#### _generate_anomaly_event()
- イベント強度決定
- AIによる創造的なイベント生成
- レスポンス解析
- AnomalyEventオブジェクト作成

### 5.3. イベント効果の例

```python
# reality_glitch の効果例
{
    "physics_distortion": 1.0,    # 物理法則の歪み度
    "random_teleport": 0.3        # ランダムテレポート確率
}

# time_anomaly の効果例
{
    "time_dilation": 1.5,         # 時間の伸縮率
    "action_repeat": 0.2          # 行動の繰り返し確率
}

# log_corruption の効果例
{
    "data_corruption": 1.0,       # データ汚染度
    "false_memories": 0.5         # 偽記憶生成確率
}
```

## 6. AIプロンプト設計

### 6.1. システムプロンプト

```
あなたは階層世界『ゲスタロカ』の混沌AIです。
世界の理（ルール）から外れた「理不尽」なイベントをランダムに発生させ、
プレイヤーに驚きと挑戦を提供する存在です。

発生させるイベント:
- 現実の歪み、物理法則の一時的崩壊
- 時間の異常、過去と未来の交錯
- 次元の裂け目、異世界からの侵入
- ログの暴走、記憶のコンテキスト汚染
- 因果律の破綻、論理の崩壊
- 記憶の歪曲、偽りの現実

イベント生成の原則:
- 予測不能で驚きに満ちている
- プレイヤーに新たな挑戦を提供
- 世界の根本的なルールに挑戦
- 時に理不尽だが、物語として魅力的
```

### 6.2. コンテキスト変数

- `chaos_level`: 現在の混沌レベル
- `anomaly_type`: 発生させるイベントタイプ
- `intensity`: イベント強度
- `character_name`: 影響を受けるキャラクター名
- `location`: 現在地
- `world_state`: 世界の状態

## 7. プレイヤーへの選択肢

各イベントタイプに応じた選択肢を自動生成：

### reality_glitch の選択肢例
1. 現実の歪みに適応を試みる（難易度：困難）
2. 理性を保ち、異常に抵抗する（難易度：普通）
3. 混沌を受け入れ、流れに身を任せる（難易度：簡単）

### time_anomaly の選択肢例
1. 現在に意識を固定する（難易度：困難）
2. 時間の流れを探索する（難易度：普通）
3. 異常が収まるのを待つ（難易度：簡単）

## 8. 他のAIとの連携

### 8.1. 状態管理AIとの連携
- イベント効果の適用
- パラメータ変更の実行
- 持続効果の管理

### 8.2. 脚本家AIとの連携
- イベント描写の物語への統合
- 選択肢の文脈化
- 後続の物語展開への影響

### 8.3. 歴史家AIとの連携
- 重要な混沌イベントの記録
- 世界史への影響の記述
- ログ暴走の歴史的意義

### 8.4. 世界の意識AIとの連携
- 世界の安定度への影響
- マクロイベントのトリガー
- 混沌エネルギーの蓄積

## 9. パフォーマンス考慮事項

### 9.1. イベント発生頻度
- 基本15%の確率で適度な頻度を維持
- クールダウンによる連続発生の防止
- 世界の状態による動的な調整

### 9.2. AIリクエストの最適化
- 高い創造性設定（temperature=0.95）
- 適切なトークン制限（max_tokens=800）
- レスポンスキャッシング（将来的実装）

## 10. テスト戦略

### 10.1. ユニットテスト
- イベント発生判定ロジック
- 混沌レベル計算
- イベントタイプ決定
- レスポンス解析

### 10.2. 統合テスト
- 他のAIエージェントとの協調動作
- イベント効果の適用
- プレイヤー体験の一貫性

### 10.3. バランステスト
- イベント頻度の適正性
- 難易度バランス
- プレイヤーフラストレーションの回避

## 11. 今後の拡張可能性

### 11.1. 新規イベントタイプ
- 感情の混沌（NPCの性格変化）
- 言語の混沌（コミュニケーション障害）
- 概念の混沌（ゲームルールの一時的変更）

### 11.2. プレイヤー介入システム
- 混沌エネルギーの意図的な操作
- 混沌イベントの予測・防御スキル
- 混沌を利用した新たなゲームプレイ

### 11.3. 混沌の連鎖反応
- 複数の混沌イベントの相互作用
- カスケード効果による大規模イベント
- 世界崩壊シナリオへの発展